import{r as i,j as a,H as O}from"./app-_R8YjR2C.js";import{A as B}from"./AuthenticatedLayout-CYL0c3Qo.js";import"./ApplicationLogo-DxSaJDP6.js";import"./ResponsiveNavLink-Di4kS9Rn.js";import"./transition-DX_QUlZh.js";function z({warehouses:v=[],projects:S=[]}){var C;const[d,E]=i.useState(((C=v[0])==null?void 0:C.id)||""),[N,k]=i.useState(""),[c,u]=i.useState([f()]),[q,p]=i.useState({}),[j,x]=i.useState({}),[w,b]=i.useState(!1),g=i.useRef({});function f(){return{id:Date.now()+Math.random(),product:null,query:"",quantity:"",project_id:"",note:"",available:null,localError:null}}function _(){u(t=>[...t,f()])}function L(t){u(s=>s.filter(r=>r.id!==t))}function m(t,s){u(r=>r.map(e=>e.id===t?{...e,...s}:e))}function F(t,s){if(!s||s.length<1){p(r=>({...r,[t]:[]}));return}g.current[t]&&clearTimeout(g.current[t]),g.current[t]=setTimeout(()=>{fetch(`/api/products/search?q=${encodeURIComponent(s)}`).then(r=>r.json()).then(r=>p(e=>({...e,[t]:r}))).catch(()=>p(r=>({...r,[t]:[]})))},200)}i.useEffect(()=>{const t=c.map(r=>{var e;return(e=r.product)==null?void 0:e.id}).filter(Boolean);if(!d||t.length===0){u(r=>r.map(e=>({...e,available:e.product?0:null,localError:null}))),x({});return}const s=[...new Set(t)];fetch(`/api/stock/batch-qty?warehouse_id=${d}&product_ids=${s.join(",")}`).then(r=>r.json()).then(r=>{const e=r.quantities||{};x(e),u(n=>n.map(o=>{if(!o.product)return{...o,available:null,localError:null};const l=e[o.product.id]??0,h=parseFloat(o.quantity||0),y=h>l?`المطلوب (${h}) أكبر من المتاح (${l})`:null;return{...o,available:l,localError:y}}))}).catch(()=>{x({})})},[d,c.map(t=>{var s;return(s=t.product)==null?void 0:s.id}).join(",")]);function P(t,s){var h;m(t,{quantity:s});const r=c.find(y=>y.id===t),e=(h=r==null?void 0:r.product)==null?void 0:h.id,n=e?j[e]??0:null,o=parseFloat(s||0),l=n!==null&&o>n?`المطلوب (${o}) أكبر من المتاح (${n})`:null;m(t,{localError:l})}function R(){if(c.map(s=>({product:s.product,qty:parseFloat(s.quantity||0)})).filter(s=>s.product).length===0)return alert("أضف صنف واحد على الأقل مع كمية صحيحة"),!1;for(const s of c){if(!s.product)return alert("هناك سطر بدون منتج"),!1;const r=parseFloat(s.quantity||0);if(!r||r<=0)return alert("تأكد من إدخال كمية صحيحة أكبر من صفر لكل سطر"),!1;const e=j[s.product.id]??0;if(r>e)return alert(`الكمية المطلوبة للمنتج ${s.product.name} أكبر من المتاح (${e})`),!1}return!0}async function T(t){var r;if(t.preventDefault(),!d)return alert("اختر مخزن");if(!R())return;const s=c.map(e=>({product_id:e.product.id,quantity:parseFloat(e.quantity),project_id:e.project_id||null,note:e.note||null}));b(!0);try{const e=await fetch("/stock/out",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":((r=document.querySelector('meta[name="csrf-token"]'))==null?void 0:r.content)||""},body:JSON.stringify({warehouse_id:d,project_id:N||null,items:s})});if(e.status===422){const n=await e.json();if(n.insufficient){const o=n.insufficient.map(l=>`${l.product_name??"id:"+l.product_id} — المطلوب: ${l.required} — المتاح: ${l.available}`).join("\\n");alert("فشل الصرف — الكميات غير كافية:\\n"+o)}else alert("فشل في عملية الصرف: "+(n.message||"خطأ غير معروف"));b(!1);return}if(!e.ok){const n=await e.text();throw new Error(n||"خطأ من السيرفر")}alert("تم صرف الأصناف بنجاح"),u([f()]),x({})}catch(e){alert("خطأ: "+(e.message||"فشل الاتصال"))}finally{b(!1)}}function $(t,s){m(t,{product:s,query:`${s.name} (${s.code})`,available:null,localError:null}),p(r=>({...r,[t]:[]}))}return a.jsx(B,{children:a.jsxs("div",{className:"max-w-5xl mx-auto p-6",children:[a.jsx(O,{title:"صرف  — مخزن"}),a.jsx("h1",{className:"text-2xl font-semibold mb-4",children:"صرف  — إخراج عدة أصناف من مخزن"}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[a.jsxs("div",{children:[a.jsx("label",{className:"block text-sm mb-1",children:"المخزن"}),a.jsx("select",{value:d,onChange:t=>E(t.target.value),className:"w-full border rounded px-3 py-2 bg-white",children:v.map(t=>a.jsx("option",{value:t.id,children:t.name},t.id))})]}),a.jsxs("div",{className:"md:col-span-2",children:[a.jsx("label",{className:"block text-sm mb-1",children:"مشروع ال (اختياري)"}),a.jsxs("select",{value:N,onChange:t=>k(t.target.value),className:"w-full border rounded px-3 py-2 bg-white",children:[a.jsx("option",{value:"",children:"— لا يوجد —"}),S.map(t=>a.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),a.jsxs("form",{onSubmit:T,className:"space-y-4",children:[c.map((t,s)=>{var r;return a.jsxs("div",{className:"grid grid-cols-12 gap-3 items-start bg-white p-3 border rounded",children:[a.jsxs("div",{className:"col-span-5 relative",children:[a.jsx("label",{className:"text-xs text-gray-600",children:"المنتج"}),a.jsx("input",{value:t.query,onChange:e=>{m(t.id,{query:e.target.value,product:null}),F(t.id,e.target.value)},placeholder:"ابحث بالاسم أو الكود",className:"w-full border rounded px-3 py-2"}),((r=q[t.id])==null?void 0:r.length)>0&&a.jsx("ul",{className:"absolute left-0 right-0 mt-1 border rounded bg-white max-h-48 overflow-auto z-40 shadow",children:q[t.id].map(e=>a.jsxs("li",{onClick:()=>$(t.id,e),className:"p-2 hover:bg-gray-100 cursor-pointer",children:[a.jsx("div",{className:"font-medium",children:e.name}),a.jsxs("div",{className:"text-xs text-gray-600",children:[e.code," — ",e.unit]})]},e.id))})]}),a.jsxs("div",{className:"col-span-2",children:[a.jsx("label",{className:"text-xs text-gray-600",children:"الكمية"}),a.jsx("input",{type:"number",step:"0.0001",value:t.quantity,onChange:e=>P(t.id,e.target.value),className:"w-full border rounded px-3 py-2"})]}),a.jsxs("div",{className:"col-span-1",children:[a.jsx("label",{className:"text-xs text-gray-600",children:"الرصيد"}),a.jsx("div",{className:"mt-1 text-sm",children:t.product?t.available??j[t.product.id]??"...":"-"})]}),a.jsxs("div",{className:"col-span-1 flex justify-end gap-1",children:[a.jsx("button",{type:"button",onClick:()=>L(t.id),className:"text-red-600",children:"حذف"}),s===c.length-1&&a.jsx("button",{type:"button",onClick:_,className:"text-blue-600",children:"إضافة سطر"})]}),a.jsxs("div",{className:"col-span-12 mt-2",children:[a.jsx("label",{className:"text-xs text-gray-600",children:"ملاحظة (اختياري)"}),a.jsx("input",{value:t.note,onChange:e=>m(t.id,{note:e.target.value}),className:"w-full border rounded px-3 py-2"}),t.localError&&a.jsx("div",{className:"text-sm text-red-600 mt-1",children:t.localError})]})]},t.id)}),a.jsxs("div",{className:"flex gap-3",children:[a.jsx("button",{disabled:w,type:"submit",className:"px-4 py-2 bg-red-600 text-white rounded",children:w?"جاري التنفيذ...":"سجل الصرف"}),a.jsx("button",{type:"button",onClick:()=>u([f()]),className:"px-3 py-2 border rounded",children:"إفراغ"})]})]})]})})}export{z as default};
