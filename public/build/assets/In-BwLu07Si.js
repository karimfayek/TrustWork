import{r as o,j as s,H as q}from"./app-1hIuEV39.js";import{A as L}from"./AuthenticatedLayout-DnQdrDhT.js";import"./ApplicationLogo-DxR6-Vjg.js";import"./ResponsiveNavLink-BqjyqXF3.js";import"./transition-dxy0kwkS.js";function P({warehouses:x=[],suppliers:_=[]}){var b;const[n,j]=o.useState(((b=x[0])==null?void 0:b.id)||""),[u,i]=o.useState([l()]),[h,c]=o.useState({}),[f,y]=o.useState(!1),m=o.useRef({});function l(){return{id:Date.now()+Math.random(),product:null,query:"",quantity:"",supplier_id:"",note:""}}function N(){i(e=>[...e,l()])}function v(e){i(r=>r.filter(t=>t.id!==e))}function d(e,r){i(t=>t.map(a=>a.id===e?{...a,...r}:a))}function w(e,r){if(!r||r.length<1){c(t=>({...t,[e]:[]}));return}m.current[e]&&clearTimeout(m.current[e]),m.current[e]=setTimeout(()=>{fetch(`/api/products/search?q=${encodeURIComponent(r)}`).then(t=>t.json()).then(t=>c(a=>({...a,[e]:t}))).catch(()=>c(t=>({...t,[e]:[]})))},250)}function C(e,r){d(e,{product:r,query:`${r.name} (${r.code})`}),c(t=>({...t,[e]:[]}))}function S(e,r){if(!n||!e)return r(0);fetch(`/api/stock/${n}/${e}`).then(t=>t.json()).then(t=>r(Number(t.quantity||0))).catch(()=>r(0))}async function k(e){e.preventDefault();const r=u.map(t=>{var a;return{product_id:((a=t.product)==null?void 0:a.id)||null,quantity:parseFloat(t.quantity||0),note:t.note||null,supplier_id:t.supplier_id||null}}).filter(t=>t.product_id&&t.quantity&&t.quantity>0);if(!n)return alert("اختر مخزن");if(r.length===0)return alert("أضف صنف واحد على الأقل وادخل كمية صحيحة");y(!0);try{const t=await fetch("/stock/in",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({warehouse_id:n,items:r})});if(!t.ok){const a=await t.text();let g=a;try{const p=JSON.parse(a);g=p.message||JSON.stringify(p)}catch{}throw new Error(g||"فشل في عملية التوريد")}alert("تم إضافة الأصناف إلى المخزن بنجاح"),i([l()])}catch(t){alert("خطأ: "+(t.message||"فشل غير معروف"))}finally{y(!1)}}return s.jsx(L,{children:s.jsxs("div",{className:"max-w-4xl mx-auto p-6",children:[s.jsx(q,{title:"توريد — إضافة عدة أصناف"}),s.jsx("h1",{className:"text-2xl font-semibold mb-4",children:"توريد — إضافة عدة أصناف للمخزن"}),s.jsxs("div",{className:"mb-4",children:[s.jsx("label",{className:"block text-sm mb-1",children:"المخزن"}),s.jsx("select",{value:n,onChange:e=>j(e.target.value),className:"w-full border rounded px-3 py-2 bg-white",children:x.map(e=>s.jsx("option",{value:e.id,children:e.name},e.id))})]}),s.jsxs("form",{onSubmit:k,className:"space-y-4",children:[u.map((e,r)=>{var t;return s.jsxs("div",{className:"grid grid-cols-12 gap-3 items-end bg-white p-3 border rounded",children:[s.jsxs("div",{className:"col-span-5 relative",children:[s.jsx("label",{className:"text-xs text-gray-600",children:"المنتج"}),s.jsx("input",{value:e.query,onChange:a=>{d(e.id,{query:a.target.value,product:null}),w(e.id,a.target.value)},placeholder:"ابحث بالاسم أو الكود أو الصق الباركود",className:"w-full border rounded px-3 py-2"}),((t=h[e.id])==null?void 0:t.length)>0&&s.jsx("ul",{className:"absolute left-0 right-0 mt-1 border rounded bg-white max-h-48 overflow-auto z-40 shadow",children:h[e.id].map(a=>s.jsxs("li",{onClick:()=>C(e.id,a),className:"p-2 hover:bg-gray-100 cursor-pointer",children:[s.jsx("div",{className:"font-medium",children:a.name}),s.jsxs("div",{className:"text-xs text-gray-600",children:[a.code," — ",a.unit]})]},a.id))})]}),s.jsxs("div",{className:"col-span-2",children:[s.jsx("label",{className:"text-xs text-gray-600",children:"الكمية"}),s.jsx("input",{type:"number",step:"0.0001",value:e.quantity,onChange:a=>d(e.id,{quantity:a.target.value}),className:"w-full border rounded px-3 py-2"})]}),s.jsxs("div",{className:"col-span-1",children:[s.jsx("label",{className:"text-xs text-gray-600",children:"إظهار"}),s.jsx("button",{type:"button",onClick:()=>{if(!e.product)return alert("اختر منتج أولا");S(e.product.id,a=>alert(`الرصيد الحالي في المخزن: ${a}`))},className:"w-full border rounded px-2 py-2",children:"رصيد"})]}),s.jsxs("div",{className:"col-span-2 flex justify-end gap-1",children:[s.jsx("button",{type:"button",onClick:()=>v(e.id),className:"text-red-600",children:"حذف"}),r===u.length-1&&s.jsx("button",{type:"button",onClick:N,className:"text-blue-600",children:"إضافة سطر"})]}),s.jsxs("div",{className:"col-span-12 mt-2",children:[s.jsx("label",{className:"text-xs text-gray-600",children:"ملاحظة (اختياري)"}),s.jsx("input",{value:e.note,onChange:a=>d(e.id,{note:a.target.value}),className:"w-full border rounded px-3 py-2"})]})]},e.id)}),s.jsxs("div",{className:"flex gap-3",children:[s.jsx("button",{disabled:f,type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded",children:f?"جاري الحفظ...":"سجل التوريد"}),s.jsx("button",{type:"button",onClick:()=>i([l()]),className:"px-3 py-2 border rounded",children:"إفراغ"})]})]})]})})}export{P as default};
