import{a as ee,r as g,j as t,b as M}from"./app-010wRZBS.js";import{C as te}from"./CalcItemsExtraction-CWxCxBZp.js";import{A as ne}from"./AuthenticatedLayout-wz4UIe47.js";import{E as se}from"./ExtractionPreview-C9HJtLqe.js";import oe from"./Items-CklzNm99.js";import"./ApplicationLogo-CLCJLUPQ.js";import"./ResponsiveNavLink-dcmeS5bU.js";import"./transition-BmRszfgL.js";import"./CategoryCheckboxes-DBZonrp1.js";function xe({type:O="delevery",project:c,deductionsList:U,extractionsCount:z,prevPay:C,previousQuantities:f,edit:B=!1,extractionId:G=null,defaultDeductions:w=null,date:F=null,supply:H=!1,extraction:p=null,DefaultProgressPercentage:I=null,isNotInclusive:J=!1}){var D,L;const S=ee().props.auth.user,[m,b]=g.useState([]),[i,q]=g.useState("en"),K=(s,e,r)=>{const o=[...m];o[s][e]=Number(r)||0;const l=o[s];l.total_done=l.previous_done+l.current_done,l.total=l.total_done*l.unit_price/100*l.progress_percentage,l.total=Number(l.total.toFixed(2)),b(o)},V=I!==null?I:100,E=w!==null?w:{vat:"5",profit_tax:"1",initial_insurance:"5",taxes:"5",advance_payment:c.advance_payment||0,social_insurance:"3.6",previous_payments:C,progress_percentage:V,other_tax:"0"},[n,x]=g.useState({type:O,num:z+1,supply:H,subject:"",isnotinclusive:J,customer_name:c.customer_name||"",project_code:c.project_code||"",date:F||"",deductions:E,previous_payments:0,notes:""}),N=(D=n.deductions)==null?void 0:D.progress_percentage;console.log(N,"progress pres");const T=g.useRef(!0);g.useEffect(()=>{if(T.current){if(console.log("first render"),T.current=!1,p!==null){console.log("extraction not null");const s=p.items.map(e=>{var h,a,j,y,v;const r=Number(e.quantity),o=e.previous_done,l=e.current_done,d=e.total_done,_=Number(e.total).toFixed(2);return{task_id:e.task_id,title:i==="en"?(h=e.task)==null?void 0:h.title:(a=e.task)==null?void 0:a.description,unit:(j=e.task)==null?void 0:j.unit,quantity:r,unit_price:Number((y=e.task)==null?void 0:y.unit_price),tp:Number((v=e.task)==null?void 0:v.tp),previous_done:o,current_done:Number(l.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(e.progress_percentage||0),total:_}});b(s);return}}else if(console.log("not first render"),p!==null){console.log("extraction not null in not first render");const s=p.items.map(e=>{var a,j,y,v,A,P;const r=Number(e.quantity),o=e.previous_done,l=e.current_done,d=e.total_done,_=((a=n.deductions)==null?void 0:a.progress_percentage)||0,h=Number(d*e.unit_price/100*_).toFixed(2);return{task_id:e.task_id,title:i==="en"?(j=e.task)==null?void 0:j.title:(y=e.task)==null?void 0:y.description,unit:(v=e.task)==null?void 0:v.unit,quantity:r,unit_price:Number((A=e.task)==null?void 0:A.unit_price),tp:Number((P=e.task)==null?void 0:P.tp),previous_done:o,current_done:Number(l.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(N||0),total:h}});b(s);return}if(p===null){console.log("extraction is null");const s=c.tasks.map(e=>{var a;const r=Number(e.quantity),o=Number(f[e.id])>0?Number(f[e.id]):0,l=o<r?r-o:0,d=l+o,_=((a=n.deductions)==null?void 0:a.progress_percentage)||0,h=Number(d*e.unit_price/100*_).toFixed(2);return{task_id:e.id,title:i==="en"?e==null?void 0:e.title:e==null?void 0:e.description,unit:e.unit,quantity:r,unit_price:Number(e.unit_price),tp:Number(e.tp),previous_done:o,current_done:Number(l.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(N||0),total:h}});b(s),console.log(s,"inita")}},[c.tasks,(L=n.deductions)==null?void 0:L.progress_percentage,f,p,i]);const u=s=>{const{name:e,value:r}=s.target;x(o=>({...o,[e]:r}))},W=s=>{const{name:e,checked:r}=s.target;x(o=>({...o,[e]:r}))},X=s=>{const{name:e,checked:r}=s.target;x(o=>({...o,[e]:r}))},Y=s=>{s.preventDefault(),q(i==="en"?"ar":"en")};g.useEffect(()=>{n.supply?x(s=>({...s,deductions:{vat:"0",profit_tax:"0",initial_insurance:"0",taxes:"0",advance_payment:"0",social_insurance:"0",previous_payments:C,progress_percentage:"100",other_tax:"0"}})):x(s=>({...s,deductions:E}))},[n.supply]);const R=(s,e)=>{const{value:r}=s.target;x(o=>({...o,deductions:{...o.deductions,[e]:r}}))},Z=s=>{s.preventDefault(),setShowPrint(!0)},k=te(m,n.deductions,n.isnotinclusive,n.supply),$=s=>{if(n.date==="")return;s.preventDefault();const e={type:n.type,supply:n.supply,num:n.num,isnotinclusive:n.isnotinclusive,date:n.date,customer_name:n.customer_name,project_code:n.project_code,deductions:n.deductions,notes:n.notes,total:k.totalCost,netTotal:k.netTotal,netotherTotal:k.netTotalOther,items:m};B?M.post(route("project.extractions.update",G),e):M.post(route("project.extractions.store",c.id),e)},Q=s=>{const e=[...m];e.splice(s,1),b(e)};return t.jsxs(ne,{children:[t.jsxs("form",{onSubmit:Z,className:"print:hidden space-y-4  mx-auto bg-white p-6 rounded-2xl shadow",children:[t.jsxs("div",{className:"bg-blue-50 flex items-center justify-between p-4 sticky top-0",children:[t.jsx("h2",{className:"font-bold text-2xl text-center",children:"طلب صرف مستخلص"}),t.jsxs("button",{onClick:s=>Y(s),children:[i==="en"&&"عربى",i==="ar"&&"انجليزى"]}),t.jsx("button",{className:"bg-green-100 border border-green-700 px-3 text-2xl",onClick:s=>$(s),children:"حفظ"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"نوع المستخلص"}),t.jsxs("div",{className:"grid grid-cols-2",children:[t.jsxs("select",{name:"type",value:n.type,onChange:u,className:"w-full p-2 border rounded",children:[t.jsx("option",{value:"delevery",children:" أذن تسليم"}),t.jsx("option",{value:"report",children:" محضر تسليم"}),t.jsx("option",{value:"mir",children:" MIR"}),t.jsx("option",{value:"ir",children:" IR"}),t.jsx("option",{value:"qs",children:" QS"}),S.email!=="sherok@trustits.net"&&t.jsxs(t.Fragment,{children:[t.jsx("option",{value:"partial",children:"جاري  "}),t.jsx("option",{value:"final",children:" ختامي"})]})]}),(n.type==="partial"||n.type==="final"||n.type==="mir")&&t.jsx("input",{type:"number",name:"num",value:n.num,onChange:u,className:"w-full p-2 border rounded"}),n.type==="ir"&&t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"subject "}),t.jsx("input",{type:"text",name:"subject",value:n.subject,onChange:u,className:"w-full p-2 border rounded"})]}),n.type==="partial"&&t.jsx(t.Fragment,{children:t.jsx("div",{className:"mt-4",children:t.jsxs("label",{className:"flex items-center",children:[t.jsx("input",{name:"supply",type:"checkbox",checked:n.supply,onChange:W}),t.jsx("span",{className:"mr-2 text-sm text-gray-600",children:"   تشوينات  "})]})})})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"اسم العميل "}),t.jsx("input",{name:"customer_name",value:n.customer_name,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:" كود المشروع "}),t.jsx("input",{name:"project_code",value:n.project_code,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"تاريخ الطلب"}),t.jsx("input",{type:"date",name:"date",value:n.date,onChange:u,className:"w-full p-2 border rounded",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-2",children:"الاستقطاعات"}),t.jsxs("label",{className:"flex items-center my-4 print:hidden",children:[t.jsx("input",{name:"isnotinclusive",type:"checkbox",checked:n.isnotinclusive,onChange:X}),t.jsx("span",{className:"mr-2 text-sm text-gray-600",children:"   السعر غير شامل الضريبه ؟  "})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[U.map(s=>t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:s.label}),t.jsx("input",{type:"number",step:"0.01",className:"w-full p-2 border rounded",value:n.deductions[s.key]||"",onChange:e=>R(e,s.key)})]},s.key)),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"نسبه الانجاز"}),t.jsx("input",{type:"number",className:"w-full p-2 border rounded",value:n.deductions.progress_percentage||"",onChange:s=>R(s,"progress_percentage")})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"ملاحظات"}),t.jsx("textarea",{name:"notes",value:n.notes,onChange:u,className:"w-full p-2 border rounded"})]}),t.jsx("button",{onClick:()=>window.print(),className:"print:hidden fixed bottom-0 left-0 right-0 w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700 transition",children:"طباعة"})]}),n.type!=="ir"&&t.jsx(oe,{items:m,handleItemChange:K,handleDeleteItem:Q,logedinUser:S}),t.jsx(se,{delevery:n.type,subject:n.subject,deductions:n.deductions,project:c,items:m,type:n.supply&&n.type==="partial"?"supply":n.type,date:n.date,customer:n.customer_name,projectCode:n.project_code,num:n.num,supply:n.supply,notes:n.notes,isNotInclusive:n.isnotinclusive})]})}export{xe as default};
