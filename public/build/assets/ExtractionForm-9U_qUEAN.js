import{r as p,a as ne,j as t,c as se,b as L}from"./app-BW0XY6q3.js";import{C as oe}from"./CalcItemsExtraction-CWxCxBZp.js";import{A as re}from"./AuthenticatedLayout-DmTnd6uR.js";import{E as ae}from"./ExtractionPreview-Dt5IBRj9.js";import le from"./Items-BEwfec-y.js";import"./ApplicationLogo-U0FYEhI-.js";import"./ResponsiveNavLink-CKHuipxy.js";import"./transition-DAtcZl1K.js";import"./CategoryCheckboxes-5xVJqGaf.js";function be({type:O="",project:l,deductionsList:K,extractionsCount:M,prevPay:k,prevQTYs:U,edit:X=!1,extractionId:Y=null,defaultDeductions:w=null,date:F=null,supply:$=!1,extraction:m=null,DefaultProgressPercentage:I=null,isNotInclusive:z=!1}){var P,Q;const[f,B]=p.useState(U),S=ne().props.auth.user,[x,b]=p.useState([]),[c,T]=p.useState("en"),G=(s,e,r)=>{const o=[...x];o[s][e]=Number(r)||0;const a=o[s];a.total_done=a.previous_done+a.current_done,a.total=a.total_done*a.unit_price/100*a.progress_percentage,a.total=Number(a.total.toFixed(2)),b(o)},H=I!==null?I:100,q=w!==null?w:{vat:"5",profit_tax:"1",initial_insurance:"5",taxes:"5",advance_payment:l.advance_payment||0,social_insurance:"3.6",previous_payments:k,progress_percentage:H,other_tax:"0"},[n,h]=p.useState({type:O,num:M+1,supply:$,subject:"",isnotinclusive:z,customer_name:l.customer_name||"",project_code:l.project_code||"",date:F||"",deductions:q,previous_payments:0,notes:""}),N=(P=n.deductions)==null?void 0:P.progress_percentage;console.log(N,"progress pres");const E=p.useRef(!0);p.useEffect(()=>{if(E.current){if(console.log("first render"),E.current=!1,m!==null){console.log("extraction not null");const s=m.items.map(e=>{var g,i,j,y,v;const r=Number(e.quantity),o=e.previous_done,a=e.current_done,d=e.total_done,_=Number(e.total).toFixed(2);return{task_id:e.task_id,title:c==="en"?(g=e.task)==null?void 0:g.title:(i=e.task)==null?void 0:i.description,unit:(j=e.task)==null?void 0:j.unit,quantity:r,unit_price:Number((y=e.task)==null?void 0:y.unit_price),tp:Number((v=e.task)==null?void 0:v.tp),previous_done:o,current_done:Number(a.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(e.progress_percentage||0),total:_}});b(s);return}}else if(console.log("not first render"),m!==null){console.log("extraction not null in not first render");const s=m.items.map(e=>{var i,j,y,v,A,D;const r=Number(e.quantity),o=e.previous_done,a=e.current_done,d=e.total_done,_=((i=n.deductions)==null?void 0:i.progress_percentage)||0,g=Number(d*e.unit_price/100*_).toFixed(2);return{task_id:e.task_id,title:c==="en"?(j=e.task)==null?void 0:j.title:(y=e.task)==null?void 0:y.description,unit:(v=e.task)==null?void 0:v.unit,quantity:r,unit_price:Number((A=e.task)==null?void 0:A.unit_price),tp:Number((D=e.task)==null?void 0:D.tp),previous_done:o,current_done:Number(a.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(N||0),total:g}});b(s);return}if(m===null){console.log("extraction is null");const s=l.tasks.map(e=>{var i;const r=Number(e.quantity),o=Number(f[e.id])>0?Number(f[e.id]):0,a=o<r?r-o:0,d=a+o,_=((i=n.deductions)==null?void 0:i.progress_percentage)||0,g=Number(d*e.unit_price/100*_).toFixed(2);return{task_id:e.id,title:c==="en"?e==null?void 0:e.title:e==null?void 0:e.description,unit:e.unit,quantity:r,unit_price:Number(e.unit_price),tp:Number(e.tp),previous_done:o,current_done:Number(a.toFixed(2)),total_done:Number(d.toFixed(2)),progress_percentage:Number(N||0),total:g}});b(s),console.log(s,"inita")}},[l.tasks,(Q=n.deductions)==null?void 0:Q.progress_percentage,f,m,c]);const u=s=>{const{name:e,value:r}=s.target;e=="type"&&se.post(`${route("extraction.delevery.getPrevQTYs",[l.id,r])}`,{headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")}}).then(o=>{B(o.data),console.log(o.data,"data  ")}).catch(o=>{console.error(o)}),h(o=>({...o,[e]:r}))},J=s=>{const{name:e,checked:r}=s.target;h(o=>({...o,[e]:r}))},V=s=>{const{name:e,checked:r}=s.target;h(o=>({...o,[e]:r}))},W=s=>{s.preventDefault(),T(c==="en"?"ar":"en")};p.useEffect(()=>{n.supply?h(s=>({...s,deductions:{vat:"0",profit_tax:"0",initial_insurance:"0",taxes:"0",advance_payment:"0",social_insurance:"0",previous_payments:k,progress_percentage:"100",other_tax:"0"}})):h(s=>({...s,deductions:q}))},[n.supply]);const R=(s,e)=>{const{value:r}=s.target;h(o=>({...o,deductions:{...o.deductions,[e]:r}}))},Z=s=>{s.preventDefault(),setShowPrint(!0)},C=oe(x,n.deductions,n.isnotinclusive,n.supply),ee=s=>{if(n.date==="")return;s.preventDefault();const e={type:n.type,supply:n.supply,num:n.num,isnotinclusive:n.isnotinclusive,date:n.date,customer_name:n.customer_name,project_code:n.project_code,deductions:n.deductions,notes:n.notes,total:C.totalCost,netTotal:C.netTotal,netotherTotal:C.netTotalOther,items:x};X?L.post(route("project.extractions.update",Y),e):L.post(route("project.extractions.store",l.id),e)},te=s=>{const e=[...x];e.splice(s,1),b(e)};return t.jsxs(re,{children:[t.jsxs("form",{onSubmit:Z,className:"print:hidden space-y-4  mx-auto bg-white p-6 rounded-2xl shadow",children:[t.jsxs("div",{className:"bg-blue-50 flex items-center justify-between p-4 sticky top-0",children:[t.jsx("h2",{className:"font-bold text-2xl text-center",children:"طلب صرف مستخلص"}),t.jsxs("button",{onClick:s=>W(s),children:[c==="en"&&"عربى",c==="ar"&&"انجليزى"]}),t.jsx("button",{className:"bg-green-100 border border-green-700 px-3 text-2xl",onClick:s=>ee(s),children:"حفظ"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"نوع المستخلص"}),t.jsxs("div",{className:"grid grid-cols-2",children:[t.jsxs("select",{name:"type",value:n.type,onChange:u,className:"w-full p-2 border rounded",children:[t.jsx("option",{value:"",children:" اختر "}),t.jsx("option",{value:"delevery",children:" أذن تسليم"}),t.jsx("option",{value:"report",children:" محضر تسليم"}),t.jsx("option",{value:"mir",children:" MIR"}),t.jsx("option",{value:"ir",children:" IR"}),t.jsx("option",{value:"qs",children:" QS"}),S.email!=="sherok@trustits.net"&&t.jsxs(t.Fragment,{children:[t.jsx("option",{value:"partial",children:"جاري "}),t.jsx("option",{value:"final",children:" ختامي"})]})]}),(n.type==="partial"||n.type==="final"||n.type==="delevery"||n.type==="mir")&&t.jsx("input",{type:"number",name:"num",value:n.num,onChange:u,className:"w-full p-2 border rounded"}),n.type==="ir"&&t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium",children:["subject"," "]}),t.jsx("input",{type:"text",name:"subject",value:n.subject,onChange:u,className:"w-full p-2 border rounded"})]}),n.type==="partial"&&t.jsx(t.Fragment,{children:t.jsx("div",{className:"mt-4",children:t.jsxs("label",{className:"flex items-center",children:[t.jsx("input",{name:"supply",type:"checkbox",checked:n.supply,onChange:J}),t.jsxs("span",{className:"mr-2 text-sm text-gray-600",children:[" ","تشوينات"," "]})]})})})]})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium",children:["اسم العميل"," "]}),t.jsx("input",{name:"customer_name",value:n.customer_name,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium",children:[" ","كود المشروع"," "]}),t.jsx("input",{name:"project_code",value:n.project_code,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"تاريخ الطلب"}),t.jsx("input",{type:"date",name:"date",value:n.date,onChange:u,className:"w-full p-2 border rounded",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium mb-2",children:"الاستقطاعات"}),t.jsxs("label",{className:"flex items-center my-4 print:hidden",children:[t.jsx("input",{name:"isnotinclusive",type:"checkbox",checked:n.isnotinclusive,onChange:V}),t.jsxs("span",{className:"mr-2 text-sm text-gray-600",children:[" ","السعر غير شامل الضريبه ؟"," "]})]}),t.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[K.map(s=>t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:s.label}),t.jsx("input",{type:"number",step:"0.01",className:"w-full p-2 border rounded",value:n.deductions[s.key]||"",onChange:e=>R(e,s.key)})]},s.key)),t.jsxs("div",{children:[t.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"نسبه الانجاز"}),t.jsx("input",{type:"number",className:"w-full p-2 border rounded",value:n.deductions.progress_percentage||"",onChange:s=>R(s,"progress_percentage")})]})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium",children:"ملاحظات"}),t.jsx("textarea",{name:"notes",value:n.notes,onChange:u,className:"w-full p-2 border rounded"})]}),t.jsx("button",{onClick:()=>window.print(),className:"print:hidden fixed bottom-0 left-0 right-0 w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700 transition",children:"طباعة"})]}),n.type!=="ir"&&t.jsx(le,{items:x,handleItemChange:G,handleDeleteItem:te,logedinUser:S}),t.jsx(ae,{delevery:n.type,subject:n.subject,deductions:n.deductions,project:l,items:x,type:n.supply&&n.type==="partial"?"supply":n.type,date:n.date,customer:n.customer_name,projectCode:n.project_code,num:n.num,supply:n.supply,notes:n.notes,isNotInclusive:n.isnotinclusive})]})}export{be as default};
