import{r as i,j as e,b as D}from"./app-Bspg5fep.js";import{C as P}from"./CalcItemsExtraction-CWxCxBZp.js";import{A as q}from"./AuthenticatedLayout-Dp9BbfD2.js";import{E as T}from"./ExtractionPreview-BPf3b1X2.js";import A from"./Items-BdaTYChh.js";import"./ApplicationLogo-DdsMb_6p.js";import"./ResponsiveNavLink-bamvQo3E.js";import"./transition-B2Eo8sEY.js";import"./CategoryCheckboxes-m6h5P-yq.js";function V({project:f,extraction:o,extractionsCount:O,prevPay:L}){var h;const[l,p]=i.useState([]),y=(s,n,r)=>{const a=[...l];a[s][n]=Number(r)||0;const d=a[s];d.total_done=d.previous_done+d.current_done,d.total=d.total_done*d.unit_price/100*d.progress_percentage,d.total=Number(d.total.toFixed(2)),p(a)},[t,c]=i.useState({type:"partial",num:o.partial_number,supply:o.supply,customer_name:o.customer_name||"",project_code:o.project_code||"",date:o.date,deductions:o.deductions_json,previous_payments:o.deductions_json.previous_payments,notes:o.notes}),m=(h=o.deductions_json)==null?void 0:h.progress_percentage,[x,R]=i.useState(o.deductions_json),v={vat:"ضريبة القيمة المضافة",taxes:"ضرائب",other_tax:"ضريبة أخرى",profit_tax:"أرباح تجارية وصناعية",advance_payment:"دفعة مقدمة",social_insurance:"تأمينات اجتماعية",initial_insurance:"تأمين أعمال",previous_payments:"ما سبق صرفه",progress_percentage:"نسبة الإنجاز"};i.useEffect(()=>{const s=o.items.map(n=>{var _,b,j,g;const r=Number(n.quantity),a=n.previous_done,d=n.current_done,S=n.total_done,F=Number(n.total).toFixed(2);return{task_id:n.task_id,title:(_=n.task)==null?void 0:_.title,unit:(b=n.task)==null?void 0:b.unit,quantity:r,unit_price:Number((j=n.task)==null?void 0:j.unit_price),tp:Number((g=n.task)==null?void 0:g.tp),previous_done:a,current_done:Number(d.toFixed(2)),total_done:Number(S.toFixed(2)),progress_percentage:Number(m||0),total:F}});p(s)},[o.items,m]);const u=s=>{const{name:n,value:r}=s.target;c(a=>({...a,[n]:r}))},N=s=>{const{name:n,checked:r}=s.target;c(a=>({...a,[n]:r}))};i.useEffect(()=>{t.supply?c(s=>({...s,deductions:{vat:"0",profit_tax:"0",initial_insurance:"0",taxes:"0",advance_payment:"0",social_insurance:"0",previous_payments:t.previous_payments,progress_percentage:m,other_tax:"0"}})):c(s=>({...s,deductions:x}))},[t.supply]);const C=(s,n)=>{const{value:r}=s.target;c(a=>({...a,deductions:{...a.deductions,[n]:r}})),console.log(t.deductions,"deductions")},w=s=>{s.preventDefault(),setShowPrint(!0)},k=P(l,t.deductions),E=s=>{if(t.date==="")return;s.preventDefault();const n={type:t.type,supply:t.supply,num:t.num,date:t.date,customer_name:t.customer_name,project_code:t.project_code,deductions:t.deductions,notes:t.notes,netTotal:k.netTotal,items:l};D.post(route("project.extractions.update",o.id),n)},I=s=>{const n=[...l];n.splice(s,1),p(n)};return e.jsxs(q,{children:[e.jsxs("form",{onSubmit:w,className:"print:hidden space-y-4  mx-auto bg-white p-6 rounded-2xl shadow",children:[e.jsxs("div",{className:"bg-blue-50 flex items-center justify-between p-4 sticky top-0",children:[e.jsxs("h2",{className:"font-bold text-2xl text-center",children:["  تعديل مستخلص  ",o.customer_name]}),e.jsx("button",{className:"bg-green-100 border border-green-700 px-3 text-2xl",onClick:s=>E(s),children:"حفظ"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"نوع المستخلص"}),e.jsxs("div",{className:"grid grid-cols-2",children:[e.jsxs("select",{name:"type",value:t.type,onChange:u,className:"w-full p-2 border rounded",children:[e.jsx("option",{value:"partial",children:"جاري  "}),e.jsx("option",{value:"final",children:" ختامي"})]}),e.jsx("input",{type:"number",name:"num",value:t.num,readOnly:!0,className:"w-full p-2 border rounded"}),t.type==="partial"&&e.jsx(e.Fragment,{children:e.jsx("div",{className:"mt-4",children:e.jsxs("label",{className:"flex items-center",children:[e.jsx("input",{name:"supply",type:"checkbox",checked:t.supply,onChange:N}),e.jsx("span",{className:"mr-2 text-sm text-gray-600",children:"   تشوينات  "})]})})})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"اسم العميل "}),e.jsx("input",{name:"customer_name",value:t.customer_name,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:" كود المشروع "}),e.jsx("input",{name:"project_code",value:t.project_code,onChange:u,className:"w-full p-2 border rounded",type:"text"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"تاريخ الطلب"}),e.jsx("input",{type:"date",name:"date",value:t.date,onChange:u,className:"w-full p-2 border rounded",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"الاستقطاعات"}),e.jsx("div",{className:"grid grid-cols-2 gap-4",children:Object.entries(x).map(([s,n])=>e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"mb-1 font-semibold",children:v[s]||s}),e.jsx("input",{type:"number",className:"border p-2 rounded",value:t.deductions[s],onChange:r=>C(r,s)})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"ملاحظات"}),e.jsx("textarea",{name:"notes",value:t.notes,onChange:u,className:"w-full p-2 border rounded"})]}),e.jsx("button",{onClick:()=>window.print(),className:"print:hidden fixed bottom-0 left-0 right-0 w-full bg-green-600 text-white py-2 rounded-xl hover:bg-green-700 transition",children:"طباعة"})]}),e.jsx(A,{items:l,handleItemChange:y,handleDeleteItem:I}),e.jsx(T,{deductions:t.deductions,project:f,items:l,type:t.supply&&t.type==="partial"?"supply":t.type,date:t.date,customer:t.customer_name,projectCode:t.project_code,num:t.num,supply:t.supply})]})}export{V as default};
