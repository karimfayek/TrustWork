import{r as a,u as C,j as e,L as D,e as f}from"./app-k5SopBD2.js";import{u as F}from"./useGeolocation-BAAKlcRJ.js";import{U as k}from"./UserLayout-D9fQAYDD.js";import"./ApplicationLogo-DU4WzsOm.js";import"./ResponsiveNavLink-Da99mX_u.js";import"./transition-C9FumlRJ.js";function q({customers:h,activeVisit:d}){const{loading:g,error:l,getLocation:n}=F(),[m,w]=a.useState(null);a.useEffect(()=>{n()},[n]),a.useEffect(()=>{l&&w(l)},[l]);const[c,b]=a.useState(null),[x,u]=a.useState(null),[j,v]=a.useState(!0),[y,N]=a.useState(!1),{data:o,setData:p,post:I,processing:E}=C({customer_id:"",notes:"",report:null});console.log("LocationError:",l);const[L,i]=a.useState(!1),_=async t=>{if(t.preventDefault(),i(!0),!navigator.geolocation){i(!1),alert("المتصفح لا يدعم تحديد الموقع");return}try{const r=await n();f.post(route("visits.store"),{customer_id:o.customer_id,location:`${r.latitude},${r.longitude}`}).then(s=>{s.data.error?u(s.data.error):s.data.visit&&(b(s.data.visit.id),u(null))}).catch(s=>{console.error(s),i(!1),u("حدث خطأ أثناء إرسال البيانات")})}catch(r){i(!1),console.error("Visit start error:",r),alert(r)}i(!1)},S=async()=>{if(!o.report){v(!1),alert("Please upload a file");return}const t=await n(),r=new FormData;r.append("customer_id",o.customer_id),r.append("notes",o.notes),r.append("report",o.report),r.append("location",`${t.latitude},${t.longitude}`);try{const s=await f.post(route("visits.update",c),r,{headers:{"Content-Type":"multipart/form-data"}});console.log(s),s.data.success&&(N(!0),window.location.href=s.data.redirect)}catch(s){console.error(s)}};return e.jsx(k,{children:e.jsxs("div",{className:"mt-10 p-4 max-w-xl mx-auto bg-white rounded shadow",children:[x&&e.jsxs("div",{className:"bg-[#FF2D20]/10 p-4 rounded shadow text-yellow-900 mb-6",children:[e.jsxs("p",{children:["  ",x]}),g&&e.jsx("p",{className:"text-gray-600",children:"جاري الحصول على الموقع..."}),m&&e.jsxs("p",{className:"text-red-500",children:["خطأ في تحديد الموقع: ",m]})]}),!c&&!d&&e.jsxs("div",{children:[e.jsxs("select",{value:o.customer_id,onChange:t=>p("customer_id",t.target.value),className:"mb-4 border px-4 py-2 w-full",children:[e.jsx("option",{value:"",children:"اختر العميل"}),h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("button",{onClick:t=>_(t),disabled:!o.customer_id||L,className:"bg-blue-600 text-white px-4 py-2 rounded disabled:opacity-25",children:"بدء الزيارة"})]}),c&&e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsx("textarea",{value:o.notes,onChange:t=>p("notes",t.target.value),placeholder:"ملاحظات الزيارة",className:"w-full border p-2"}),e.jsx("input",{type:"file",onChange:t=>p("report",t.target.files[0]),className:j?"w-full":"w-full bg-[#FF2D20]/10",required:!0}),e.jsx("button",{onClick:S,className:"bg-green-600 text-white px-4 py-2 rounded disabled:opacity-25",disabled:E||y,children:"إنهاء الزيارة"})]}),d&&e.jsxs("div",{className:"bg-yellow-100 p-4 rounded shadow text-yellow-900 mb-6",children:[e.jsx("p",{children:"أنت في زيارة حالياً، يجب إنهاؤها أولاً قبل بدء زيارة جديدة."}),e.jsx(D,{href:route("visits.show",d.id),className:"text-blue-600 underline mt-2 inline-block",children:"الذهاب إلى الزيارة الحالية"})]})]})})}export{q as default};
